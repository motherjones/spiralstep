<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script type="text/javascript" src="js/libs/tabletop.js"></script>
        <script type="text/javascript" src="js/libs/underscore-min.js"></script>
        <script type="text/javascript" src="js/libs/jquery/jquery.js"></script>
        <script type="text/javascript" src="js/libs/dust-full-1.2.3.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <style>

        text {
          font: 10px sans-serif;
        }

        </style>
    </head>
<body>
    <div id="social_buttons">
        <a href="#" id="social_previous">
            &lt;&lt;
        </a>
        <a href="#" id="social_next">
            &gt;&gt;
        </a>
    </div>
<script>
    //URL to public google spreadsheet
    var public_spreadsheet_url = 'https://docs.google.com/spreadsheet/pub?key=0AswaDV9q95oZdDBMNEpQOWdOcF8zVVl5eWhqQTBkQmc&output=html';

window.onload = function() {

        Tabletop.init( { 
            key: public_spreadsheet_url,
            callback: function(dataset) {
                make_social_web(dataset);
            },
            simpleSheet: true 
        } )
};

var make_social_web = function(dataset) {
    //turn dataset into something d3 can eat
    var tooltip_template = ' \
        <h3>{name}</h3> \
        <p>Part of {socialgroup}</p> \
        <p>{blurb}</p> \
    ';
    var compiled_tooltip = dust.compile(tooltip_template, 'tooltip');
    dust.loadSource(compiled_tooltip);
    var created_social_groups = {};
    for (var i = 0; i < dataset.length; i++) {
        if(!created_social_groups[dataset[i].socialgroup]) {
            created_social_groups[dataset[i].socialgroup] = {
                name: dataset[i].socialgroup,
                children: []
            };
        }

        created_social_groups[dataset[i].socialgroup].children.push(
            dataset[i]
        )
        dataset[i].image = 'http://i.imgur.com/neeKqKL.gif';

        dust.render('tooltip', dataset[i], function(err, out) {
            dataset[i].tooltip = out
        })

    }

    var root = {
        name: 'social graph',
        children: []
    };

    for (var group in created_social_groups) {
        root.children.push(created_social_groups[group])
    }


    var diameter = 630,
        format = d3.format(",d"),
        color = d3.scale.category10();

    var bubble = d3.layout.pack()
        .sort(null)
        .size([diameter, diameter])
        .padding(1.5);

    var svg = d3.select("body").append("svg")
        .attr("width", diameter)
        .attr("height", diameter)
        .attr("class", "bubble");

      var node = svg.selectAll(".node")
          .data(bubble.nodes(classes(root))
          .filter(function(d) { return !d.children; }))
        .enter().append("g")
          .attr("class", "node")
          .attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")"; });

      node.append("title")
          .text(function(d) { 
              return d.tooltip;
          });

      node.append("circle")
          .attr("r", function(d) { return d.r; })
          .style("fill", function(d) { return color(d.packageName); });

      node.append("text")
          .attr("dy", ".3em")
          .style("text-anchor", "middle")
          .text(function(d) { return d.className.substring(0, d.r / 3); });

      node.append("image")
          .attr("xlink:href", function(d) { return d.image })
          .attr("x", function(d) { return -(d.r / 2) })
          .attr("y", function(d) { return -(d.r / 2) })
          .attr("width", function(d) { return d.r })
          .attr("height", function(d) { return d.r });


      var buttons = []

      var all_button = jQuery('<button>All</button>');
      all_button.click(function() {
          console.log('all');
          jQuery('#social_buttons button').removeClass('selected');
          all_button.addClass('selected');
          node
            .transition()
            .style('opacity', 1)
            .duration(1000)
        ;
      });
      buttons.push(all_button);

      jQuery('#social_buttons').append( all_button );
      for (var group in created_social_groups) {
          var button = jQuery('<button>' + group + '</button>');
          (function(group, button) {
              button.click(function() {
                  jQuery('#social_buttons button').removeClass('selected');
                  button.addClass('selected');
                  node
                    .transition()
                    .style('opacity', function(d) {
                        return (d.packageName === group
                            ? 1
                            : 0.15
                        );
                    })
                    .duration(1000)
                ;
              });
          })(group, button)
          jQuery('#social_buttons').append( button );
          buttons.push(button);
      }
      jQuery('#social_previous').click(function() {
          for (var i = 0; i < buttons.length; i++) {
              if (buttons[i].hasClass('selected') && i > 0) {
                  buttons[(i-1)].click();
              }
          }
          return false;
      });
      jQuery('#social_next').click(function() {
          for (var i = 0; i < buttons.length; i++) {
              if (buttons[i].hasClass('selected') && i < (buttons.length - 1)) {
                  buttons[(i+1)].click();
                  return false;
              }
          }
          return false;
      });
      all_button.click();
    // Returns a flattened hierarchy containing all leaf nodes under the root.
    function classes(root) {
      var classes = [];

      function recurse(name, node) {
        if (node.children) node.children.forEach(function(child) { recurse(node.name, child); });
        else classes.push({
            packageName: name,
            className: node.name,
            value: (node.size ? node.size : 1),
            image: (node.image),
            tooltip: node.tooltip
        });
      }

      recurse(null, root);
      return {children: classes};
    }

    d3.select(self.frameElement).style("height", diameter + "px");
}

</script>
</body>
</html>
